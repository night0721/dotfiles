#!/bin/sh

. $HOME/.rc

notify-send "Getting list of available Wi-Fi networks..."
# Get a list of available wifi connections and morph it into a nice-looking list
wifi_id_list=$(connmanctl services | sed -n 's/^.*wifi_//p' | sed 's/^/wifi_/' | tr ' ' '\n')
wifi_names=()
wifi_ids=()

# Loop through each item in the wifi_id_list
while IFS= read -r wifi_id; do
    # Get the name of the Wi-Fi network and append it to wifi_names array
    wifi_name=$(connmanctl services "$wifi_id" | grep "Name = " | cut -c 27-)
    wifi_names+=("$wifi_name")
    wifi_ids+=("$wifi_id")
done <<< "$wifi_id_list"

connected=$(connmanctl state)
if [[ "$connected" =~ "online" ]]; then
        toggle="󰖪  Disable Wi-Fi"
elif [[ "$connected" =~ "offline" ]]; then
        toggle="󰖩  Enable Wi-Fi"
fi

# Use rofi to select wifi network
chosen_network=$(printf "%s\n%s\n" "$toggle" "${wifi_names[@]}" | wmenu -i -p "Wi-Fi SSID: ")
chosen_index=-1
if [ "$chosen_network" = "" ]; then
	exit
elif [ "$chosen_network" = "󰖩  Enable Wi-Fi" ]; then
	connmanctl enable wifi
elif [ "$chosen_network" = "󰖪  Disable Wi-Fi" ]; then
    connmanctl disable wifi
else
    # Find the index of the chosen network
    for i in "${!wifi_names[@]}"; do
        if [ "${wifi_names[i]}" = "$chosen_network" ]; then
            chosen_index="$i"
            break
        fi
    done
    ssid=${wifi_ids[$chosen_index]}
    if [[ "$ssid" =~ "none" ]]; then
        success_message="Connection established \"$chosen_network\"."
        connmanctl connect "${wifi_ids[$chosen_index]}" && notify-send "Connection Established" "$success_message"
    else
        wifi_password=$(echo "" | wmenu -p "Password: " )
        echo "$wifi_password" | connmanctl connect "$chosen_id" | grep "successfully" && notify-send "Connection Established" "$success_message"
    fi
fi
